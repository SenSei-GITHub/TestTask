# TestTask
Репозиторий с тестовым заданием для вакансии от ДомАвтоматика.
Проект создавался в отрыве от реальности без отладки на железе.
В корне 2 папки. Doc - документы по проекту (Алгоритм, таблица с расчетом кода ацп от температуры, само задание). Test - сам тестовый проект.

Среда CubeIDE (ver 1.11.2) CubeMX (ver 6.7.0-RC4)
Микроконтроллер STM32F103C8T6.

Настройки микрокотроллера:
	-Тактирование от внешнего кварца (8МГц)
	-HCLK 72МГц
	-ADC 12МГц
	-Timebase source TIM1
	-Debug Serial Wire
	-Все порты дискретных сигналов подтянуты к земле
	-Передача данных на другие устройства происходит по USART3 (Настройки стандартные) при помощи DMA
	-Для температуры используется ADC1 IN5 IN6. С работой через DMA. На каждый канал Sampling Time 239.5 Cycles. Ацп делает замер по такту с таймера
	-Тактирующий таймер TIM3. Trigger Event Selection - Update Event
	-FreeRTOS - CMSIS_V1
	-Каждая переферия инициализируется в отдельных парах c/h файлов
	
Основные файлы проекта лежат в папе ProjectFiles. В файле main.c инклудится General.h и больше ничего не трогается.
В General.c основной код проекта. В файле NTC.h находится массив со значениями АЦП соответствующие температуре, макросы для значений, выходящих за пределы массива.
В файле General.h находятся макросы для работы с дискретными портами и макросы для предельных значений массива ацп, счетчика.

Описание.
Задействованы 2 задачи: дефолтная задача и задача расчета температуры и выставления реле. В дефолтной задаче происходит инициализация
второй задачи и очереди для флага готовности данных с ацп, установление параметров таймера тактирующего ацп. Задача расчета температуры бесконечно
ожидает флага готовности данных с ацп.
В теле дефолтной задачи происходит опрос порта кнопки каждую 1мс. При получении высокого уровня начинается счет для фильтрации (убирается дребезг и ложные 
срабатывания). Если счетчик не дошел до максимального значения, то происходит его обнуление. В противном случае выставляется флаг начала работы задания
(Необходимо чтобы не было множественного запуска задания), запускается ацп и таймер. В прерывании ацп по готовности данных выставляется в очередь флаг.
Задача расчета температуры получает этот флаг и начинает обрабатывать полученные значения с ацп (усреднять) и методом бинарного поиска определять температуру
(в массиве каждый индекс элемента является значением температуры). После получения значения температуры происходит обработка. Если полученные значения
выходят за предел (хоты бы одно из значений) или занчения не равны друг другу с dt=1 то происходит выключение обоих реле.
Если температура ниже 25 то выключаем реле BACKWARD и включаем FORWARD.Если температура выше 25 то выключаем реле FORWARD и включаем BACKWARD. После этого
происходит передача полученных значений по уарту. В прерывании уарта по готовности передачи происходит сброс флага запуска задания. После этого
при нажатии на кнопку произойдет повторный запуск задания.

Возможные доработки.
Нет смысла по нажатию на кнопку запускать измерение температуры. Это нужно делать в фоновом режиме (температура измеряется постоянно). Добавление фильтра
на значения температуры уберет резкие выбросы. По нажатию на кнопку можно отправлять данные в уарт (но если устройство находится в связке
с другим, то в этом отпадает необходимость)